\begin{frame}{HTML parsing}
\begin{itemize}
	\item After obtaining the HTML source code, how to obtain the information required?
	\item If the HTML code is well-structured and its tags have (more or less) unique names, we can navigate the HTML elements to get the information we want.
	\item The {\tt beautifulsoup4} package converts the HTML code into a Python object that can be navigated using properties and functions.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Some HTML terms}
\begin{itemize}
	\item Consider 
		\begin{verbatim}
<a href="http://www.bccp-berlin.de" target="_blank">BCCP</a>
\end{verbatim}	 
	\item HTML Elements
	\begin{itemize}
		\item The entire thing is an HTML element. Specifically, it is a link leading to the BCCP website and displayed as "BCCP".
		\item HTML elements usually consist of a start tag and an end tag.
	\end{itemize}
	\item HTML Tags
	\begin{itemize}
		\item The start tag of the element above is {\tt <a>} and the end tag is the corresponding {\tt </a>}
		\item Start tag can and sometimes must contain attributes.
	\end{itemize}
	\item HTML Attributes
	\begin{itemize}
		\item The {\tt <a>} tag contains the attribute {\tt href} and {\tt target}. {\tt href} specifies the destination to which the link should lead and {\tt target="\_blank"} specifies that the link should be opened in a new window.
		\item For web scraping purposes, the attributes {\tt class} and {\tt id} are usually useful as these are often used to identify certain (groups of) elements.
	\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Basic HTML documents structure}
\begin{itemize}
	\item HTML documents have a tree-like/nested structure
	\item Elements can contain various levels of sub-elements that in the end contain some content
\end{itemize}
\end{frame}

\begin{frame}[fragile]{HTML document example}
\begin{verbatim}
<html>
<body>
<p>
Hi all!
</p>
<p>
Do you know 
<a href="http://www.bccp-berlin.de" target="_blank">BCCP</a>?
</p>
</body>
</html>
\end{verbatim}
\end{frame}

\begin{frame}[fragile]{Tree structure}
\begin{center}
\begin{tikzpicture}
\draw (0,0) node[above] {\verb!<html>!};
\draw (0,0) -- (0,-1) node[below] {\verb!<body>!};
\draw (0,-1.5) -- (0,-2);
\draw (-2,-2.5) node[below] {\verb!<p>!} -- (-2,-2) -- (2,-2) -- (2,-2.5) node[below] {\verb!<p>!};	
\draw (-2,-3) -- (-2,-4) node[below] {Hi all!};
\draw (2,-3) -- (2,-3.5);
\draw (1,-4) node[below] {Do you know} -- (1,-3.5) -- (3,-3.5) -- (3,-4) node[below] {\verb!<a>!} -- (3,-3.5) -- (5,-3.5) -- (5,-4) node[below] {?};
\draw (3,-4.5) -- (3,-5) node[below] {BCCP};
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}[fragile]{General steps}
\begin{enumerate}
	\item Load a web page and get the source code: Use \verb!requests! for static and \verb!selenium! for dynamic websites
	\item Convert (``parse'') the source code into a soup object: Use \verb!beautifulsoup4!
	\item Navigate/search the soup object to get the information you want
\end{enumerate}
\end{frame}

\begin{frame}{Example for today}
\begin{itemize}
	\item Let's scrape the details of all upcoming BCCP events: \url{http://www.bccp-berlin.de/events/all-events/}
	\item Steps:
		\begin{enumerate}
			\item Analyze HTML structure
			\item Load source code
			\item Save information on events available on the front page
			\item Loop through individual event pages to get details
			\item Combine to DataFrame
		\end{enumerate}
\end{itemize}
\end{frame}

\begin{frame}[fragile,allowframebreaks]{Analyzing the HTML structure}
\begin{itemize}
	\item Open \url{http://www.bccp-berlin.de/events/all-events/} in a browser and inspect the source code
	\item Information on events saved in div elements
\end{itemize}
\begin{verbatim}
<div class="eventList">
...
<div class="event-list-item event-type1">...</div>
...
<div class="event-list-item event-type2">...</div>
...
</div>
\end{verbatim}

\framebreak

\begin{itemize}
	\item Details are saved in sub-elements in each \verb!//div[contains(@class,'event-list-item')]! element
\end{itemize}
\begin{verbatim}
<div class="event-list-item event-type1">
 <div class="top-bar">
  <span class="date single">June 27, 2019</span>
  <span class="b-events__item__type">Seminar</span>
 </div>
 <div class="b-events__item__inner">
  <div class="content">
   <div class="genres">Berlin Behavioral Economics Seminar</div>
   <h2 class="eventHeader">
    <a href="/events/all-events/events-detail/
    felix-holzmeister-university-of-innsbruck/">
     Felix Holzmeister (University of Innsbruck)
    </a>
   </h2>
   <div class="teaser">Delegated Decision Making in Finance</div>
   <div class="location">
    <strong class="label">Location</strong>
    <div class="address">
     <span class="name">WZB</span>
     <span class="address">Reichpietschufer 50, Room B001</span>
     <span class="zip">10785</span>
     <span class="place">Berlin</span>
    </div>
   </div>
   <div class="time">
    <strong class="label">Time</strong>
    <span>16:45â€“18:00</span>
   </div>
  </div>
  <div class="button detail">
   <a title="Felix Holzmeister (University of Innsbruck)" 
   href="/events/all-events/events-detail/
   felix-holzmeister-university-of-innsbruck/">
    Event Details
   </a>
  </div>
 </div>
</div>
\end{verbatim}
\end{frame}

\begin{frame}{Getting the data}
\begin{itemize}
	\item Idea: Loop through listings, save details, visit details page to load more info
	\item See ``htmlparsing.ipynb''.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{From website to Python soup}
\begin{enumerate}
	\item \verb!requests!: Load website and save source code as string
	\item \verb!BeautifulSoup!: Take source string and parse to get soup object
		\begin{itemize}
			\item There are three different parsers: \verb!html.parser!, \verb!lxml!, \verb!html5lib!
			\item Differences are discussed here: \url{https://www.crummy.com/software/BeautifulSoup/bs4/doc/#installing-a-parser}
			\item I usually use \verb!lxml!
		\end{itemize}
	\item Soup object includes functions and attributes that facilitate searching and navigating HTML elements
\end{enumerate}
\end{frame}

\begin{frame}[fragile]{Some BeautifulSoup functions}
\begin{itemize}
	\item Look at the very good documentation: \url{https://www.crummy.com/software/BeautifulSoup/bs4/doc/}
	\item You can either \textit{search} the document:
	\begin{itemize}
		\item \verb!.find_all()!: Find all elements that match a certain condition. Returns a list.
		\item \verb!.find()!: Same as \verb!find_all()! but only returns first match.
	\end{itemize}
	\item If unique tag names are not available, \textit{navigation} of the HTML tree rather than searching it is possible, e.g.:
	\begin{itemize}
		\item Vertically: \verb!.parent!, \verb!.parents!, \verb!.children!
		\item Horizontally: \verb!.next_sibling!, \verb!.previous_sibling!
	\end{itemize}
\end{itemize}
\end{frame}